
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>ECE383</title>
        <meta name="description" content="ECE 383 - Embedded Systems II with the Digilent Atlys at the United States Air Force Academy (USAFA).  Covers VHDL.  Free and open FPGA course.">
        <meta name="author" content="Todd Branchflower">
        <link rel='stylesheet' type='text/css' href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css'>
        <script src='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js'></script>
		<META HTTP-EQUIV="refresh" CONTENT="120"> <!--added this line to force page refresh every 120 seconds-->
    </head>
    <body>

        <div class = "container">
            <div class = "navbar navbar-inverse">
                <div class = "navbar-inner">
                    <a class = "brand" href="../../index.html">ECE383</a>
                    <ul class="nav pull-right">
                        <li><a href="../lab2/lab2.html">Next&gt</a></li>
                    </ul>
                </div>
            </div>

<table class="table table-striped table-bordered table-condensed">
<tr><td>Start date:</td>	<td>January  22</td></tr>
<tr><td>End date:</td>		<td>January  28</td></tr>
<tr><td>Lab:</td>		<td>1</td></tr>
<tr><td>Status			<td bgcolor = #FFD0D0>In Progress <!--<td bgcolor = #FFFFF0>Not Started --> <!--<td bgcolor = #D0FFD0>Complete -->
<tr><td>Lab 1 Cutsheet<td><a href="./ECE_383_Lab1_Cutsheet.pdf">ECE_383_Lab1_Cutsheet.pdf</a>
</table>


<h1>Lab 1 - Video Synchronization</h1>

<h2>Lab Overview</h2>
In this lab, you will write a VGA controller in VHDL and implement 
it on your FPGA development board.  You will be provided a VGA-to-HDMI 
module that will automatically format your output for the HDMI output 
port on your development board.  This VGA controller will be tasked 
to generate the display portion of an oscilloscope as shown in the
figure below.  The scope face consists of a white grid, used to 
measure the signals, two trigger markers, and the waveforms.  In
this lab the waveforms will be artificially generated by your code,
but in later labs, the waveforms will be generated by incoming
audio waveforms.

<br><img src="./img/layout.jpg" alt="Figure 3"><br><br>

<h2>VGA Overview</h2>
Video Graphics Array (VGA) is an interface protocol used to transmit 
analog video data to a screen.  The VGA protocol uses a scanning method 
to project an image on the screen.  Starting in the top-left of the 
screen, the monitor will progressively move from left to right, top 
to bottom to display each pixel.  The following signals must be sent 
to a VGA monitor in order to display an image.

<ol>
<li><code>red</code>, <code>green</code>, <code>blue</code> - three 
separate analog voltage signals indicating the amount of each color 
to display in the current pixel.  These signals are sometimes 
abbreviated as RGB.</li>
<li><code>h_sync</code> - Horizontal synchronization signal that tells 
the screen to start writing pixels to the next line</li>
<li><code>v_sync</code> - Vertical synchronization signal that tells 
the screen that the current video frame is completed.  The screen then 
starts writing pixels to the top-left of the screen.</li>
</ol>

Both synchronization signals contain four unique states: 
<code>active_video</code>, <code>front_porch</code>, 
<code>sync_pulse</code>, and <code>back_porch</code>.  Incoming pixel 
data (through the RGB channels) is only displayed during the active_video 
state of the synchronization signals.<br><br>

Internally, you will use a 25MHz clock as your <code>pixel_clk</code>.  
On the rising edge of this clock, when both the <code>h_sync</code> and 
<code>v_sync</code> signals are in the active_video state, you will place 
the RGB values you want the screen to display for that pixel.  During all 
other states, the RGB values must be &quot;0&quot;.

<br><img width = 800 src="./img/figure1.jpg" alt="Figure 1"><br><br>

<strong>Figure 1</strong>: The <code>h_sync</code> signal contains four 
states.  Pixel data is only displayed on the monitor during the 
active_video state.  During all other state, the RGB values must be 
&quot;0&quot;.<br><br>

The <code>v_sync</code> signal looks nearly identical to the 
<code>h_sync</code> signal, however it is significantly stretched out 
in time.  Where the <code>h_sync</code> signal was counted in terms of 
<code>pixel_clk</code>, the <code>v_sync</code> signal is counted based 
on iterations of the <code>h_sync</code> signal.  For example, in 
Figure 2, the <code>active_video</code> portion is active for 480 
complete iterations of the <code>h_sync</code> signal.<br><br>

<br><img width = 800 src="./img/figure2.jpg" alt="Figure 2"><br><br>

<strong>Figure 2</strong>: The <code>v_sync</code> signal is similar 
to <code>h_sync</code>, but instead of counting based on 
<code>pixel_clk</code>, the states are based on the number of iterations 
of the <code>h_sync</code> signal.  Pixel data is only displayed on the 
monitor during the active_video state.  During all other state, the RGB 
values must be &quot;0&quot;.<br><br>

More details on the VGA protocol can be found at 
<a href="http://www-mtl.mit.edu/Courses/6.111/labkit/vga.shtml">http://www-mtl.mit.edu/Courses/6.111/labkit/vga.shtml</a>.  
This link provides the exact numbers needed to generate the correct 
timing pulse signals for any VGA resolution.

<h2>VHDL Code</h2>
In order to get you going in this lab, some of the VHDL code has been 
provided for you. In most cases, you should refrain from changing the
modules given.  In order to get a better understanding how these modules 
interact with one another, the following section provides a schematic
and the input, output and behavior of some of the modules.

<ul>	<li><a href="./code/lab1.vhdl">lab1.vhdl</a>
	<li><a href="./code/lab1.ucf">lab1.ucf</a>
	<li><a href="./code/video.vhdl">video.vhdl</a>
	<li><a href="./code/vga_tb.vhdl">vga_tb.vhdl</a>
	<li><a href="./code/dvid.vhdl">dvid.vhdl</a>
	<li><a href="./code/tdms.vhdl">tdms.vhdl</a>
</ul>


<h2>Architecture</h2>
The design of Lab 1 is broken down into separate modules, some of which
are provided for you and some which you will need to create.  The
interconnection of the modules is illustrated in the following schematic.
When a signal name appears just inside a box, that should should correspond
to the name of that signal in the entity description.  Please note
there are a few omissions in the diagram that you should correct
as part of your documentation (see Turn-In section).

<br><img src="./img/architecture.gif"><br><br>

There are two modules which will constitute the majority of your work, VGA
and scopeFace.  The following two subsections details the behavior of these
two modules.

<h3>The VGA module</h3>
Your main task is to build the VGA component for Lab1.  This component 
sweeps across the display from left to right, and then return to the 
left side of the next lower row.  The VGA interface determines the color
of each pixel on this journey with the help of the scopeFace component.

<pre>
entity vga is
	Port(	clk: in  STD_LOGIC;
			reset : in  STD_LOGIC;
			h_sync : out  STD_LOGIC;
			v_sync : out  STD_LOGIC; 
			blank : out  STD_LOGIC;
			r: out STD_LOGIC_VECTOR(7 downto 0);
			g: out STD_LOGIC_VECTOR(7 downto 0);
			b: out STD_LOGIC_VECTOR(7 downto 0);
			trigger_time: in unsigned(9 downto 0);
			trigger_volt: in unsigned (9 downto 0);
			row: out unsigned(9 downto 0);
			column: out unsigned(9 downto 0);
			ch1: in std_logic;
			ch1_enb: in std_logic;
			ch2: in std_logic;
			ch2_enb: in std_logic);
end vga;
</pre>

<table class="table table-striped table-bordered table-condensed">
<tr><td>clk	<td>This is the 25Mhz pixel clock generated by the DCM in 
			the video module.
<tr><td>reset	<td>This is the same active low reset signal passed into the top
			level Lab1 module.
<tr><td>tr_volt	<td>This is a 10-bit unsigned value representing the trigger 
			voltage.  This value is passed to the scopeFace module
			so that a yellow arrow (see Trigger Level Marker in the
			screen show) on the vertical axis.
<tr><td>tr_time	<td>This is a 10-bit unsigned value representing the trigger 
			time.  This value is passed to the scopeFace module
			so that a yellow arrow (see Trigger Time Marker in the
			screen show) on the horizontal axis.
<tr><td>ch1	<td>This 1-bit signal signals the VGA module to draw the channel
			1 signal on the scope for this row, column pixel.
			When the value is 1, draw a yellow pixel on
			the display at the current row,colum position.  When 0, 
			do not draw a pixel.
<tr><td>ch1_enb	<td>This 1-bit signal enable the ch1 signal to be drawn.
<tr><td>ch2	<td>This 1-bit signal signals the VGA module to draw the channel
			2 signal on the scope for this row,column pixel.
			When the value is 1, draw a green pixel on
			the display at the current row, column position.  When 0, 
			do not draw a pixel.
<tr><td>ch2_enb	<td>This 1-bit signal enable the ch2 signal to be drawn.
<tr><td>R	<td>The 8-bit red intensity for this row,column pixel on the 
			screen.
<tr><td>G	<td>The 8-bit green intensity for this row,column pixel on the 
			screen.
<tr><td>B	<td>The 8-bit blue intensity for this row,column pixel on the 
			screen.
<tr><td>Row	<td>The current row being drawn on the display.
<tr><td>Column	<td>The current row being drawn on the display.
<tr><td>blank	<td>The blank signal for the current row,column position.  Its
			the logical and of the h_blank and v_blank signals.
<tr><td>h_synch	<td>The h_synch signal for the current row,column position.
<tr><td>v_synch	<td>The v_synch signal for the current row,column position.
<tr><td>Behavior<td>

The VGA component contains a pair of cascaded counters which generate the 
row and column values of the current pixel being displayed.  The row and
column values are used to generate the blank, h_synch and v_synch signals 
according to the Figures above.  The scopeFace component (more on this below),
takes the row and column values (along with some other information) and 
generates the R,G,B color of that pixel.  The three muxes on the output
of the R,G,B output of the scopeFace component output the scopeFace R,G,B
values for row,column values within the 640x480 displayable region,
or 0's for values outside this region.
</table>



<h3>The scopeFace module</h3>
Inside the VGA module sits an instance of the scopeFace entity.  This entity 
only contains combinational logic.  When given a row,column pair, its responsible
for generating the R,G,B value of that pixel.

<pre>
entity scopeFace is
    Port ( row : in  unsigned(9 downto 0);
           column : in  unsigned(9 downto 0);
			  trigger_volt: in unsigned (9 downto 0);
			  trigger_time: in unsigned (9 downto 0);
           r : out  std_logic_vector(7 downto 0);
           g : out  std_logic_vector(7 downto 0);
           b : out  std_logic_vector(7 downto 0);
			  ch1: in std_logic;
			  ch1_enb: in std_logic;
			  ch2: in std_logic;
			  ch2_enb: in std_logic);
end scopeFace;
</pre>

<table class="table table-striped table-bordered table-condensed">
<tr><td>clk	<td>This is the 25Mhz pixel clock generated by the DCM in 
			the video module.
<tr><td>reset	<td>This is the same active low reset signal passed into the top
			level Lab1 module.
<tr><td>tr_volt	<td>This is a 10-bit unsigned value representing the trigger 
			voltage.  This value is passed to the scopeFace module
			so that a yellow arrow (see Trigger Level Marker in the
			screen show) on the vertical axis.
<tr><td>tr_time	<td>This is a 10-bit unsigned value representing the trigger 
			time.  This value is passed to the scopeFace module
			so that a yellow arrow (see Trigger Time Marker in the
			screen show) on the horizontal axis.
<tr><td>ch1	<td>This 1-bit signal signals the VGA module to draw the channel
			1 signal on the scope for this row, column pixel.
			When the value is 1, draw a yellow pixel on
			the display at the current row,column position.  When 0, 
			do not draw a pixel.
<tr><td>ch1_enb	<td>This 1-bit signal enable the ch1 signal to be drawn.
<tr><td>ch2	<td>This 1-bit signal signals the VGA module to draw the channel
			2 signal on the scope for this row,column pixel.
			When the value is 1, draw a green pixel on
			the display at the current row, column position.  When 0, 
			do not draw a pixel.
<tr><td>ch2_enb	<td>This 1-bit signal enable the ch2 signal to be drawn.
<tr><td>R	<td>The 8-bit red intensity for this row,column pixel on the 
			screen.
<tr><td>G	<td>The 8-bit green intensity for this row,column pixel on the 
			screen.
<tr><td>B	<td>The 8-bit blue intensity for this row,column pixel on the 
			screen.
<tr><td>Row	<td>The current row being drawn on the display.
<tr><td>Column	<td>The current row being drawn on the display.
<tr><td>Behavior<td>
The scopeFace component takes in the current row,column coordinates of the 
display and generates the R,G,B values at that screen coordinate. For example,
if row,column = 20,20 then the R,G,B output should be 0xFF,0xFF,0xFF (white)
because the upper left corner of the O'scope grid display is white.  Note,
you can get the RGB values for common colors at 
<a href="http://www.w3schools.com/htmL/html_colornames.asp">this</a> web site.
</table>

<h2>Required Functionality</h2>
Your code must generate the white oscilloscope grid pattern shown 
in the Figure above and draw the two channels of traces.  
To test this draw:
the channel 1 trace (yellow) along a diagonal where (row = column).
The channel 2 trace (green) should be drawn along a diagonal where
(row = 440-column).  This test code should be placed in the Lab1
entity.


<h2>A-level functionality</h2>
A-level functionality is shown in the Figure in the Lab Overview
section at the top of the page.  In addition to drawing the display, the
display must update when one of the buttons is pressed according to
the list below.

<ul>
<li>Pressing the 
upper directional button (BTNU) once should move the Trigger Level Marker up.
<li>Pressing the 
lower directional button (BTND) once should move the Trigger Level Marker down.
<li>Pressing the 
left  directional button (BTNL) once should move the Trigger Time Marker left.
<li>Pressing the 
right  directional button (BTNL) once should move the Trigger Time Marker right.
</ul>
In order to achieve this level of functionality, you will need to implement
the two Process blocks in the Lab1 entity in the schematic.
<br><br>

You need to draw the channel 1 trace (yellow) along a diagonal where (row = column).
The channel 2 trace (green) should be drawn along a diagonal where
(row = 400-column).  This test code should be placed in the Lab1
entity.


<h2>Turn In</h2>
All your work in this lab is to be submitted using Bitbucket.  The main part of the
lab is your README, documenting your design.
Your README must include the following:

<ul>
<li><strong>Introduction</strong> - Provide a brief overview of the 
problem.</li>

<li><strong>Implementation</strong> - Provide block-diagram of your 
solution using the <strong>signal names in your code</strong>.  The
block diagram given above is somewhat incomplete, make sure to include
corrections to this diagram.  For each module that you built, explain
its overall purpose, inputs, outputs, and behavior.  Include all your
vhdl files (code and testbench), wcfg file, and bit files.  Put these
in a folder called "code".</li>

<li><strong>Test/Debug</strong> - Briefly describe the methods used 
to verify system functionality.  Show at least three excerpts from your 
testbench for the VGA module (as screen shots):
<ul type="a">
<li>Show the h_synch going high, low, high, and related h count.  
<li>Show the h count rolling over causing the v count to increment
<li>Show the v_synch going high, low, high, and related v count.  
</ul>

List the major problems you encountered and how you fixed them.  
This should cover all the problems you encountered in the lab and 
how you fixed them.  Break each problem and solution into separate 
paragraphs.</li>

<li><strong>Conclusion</strong> - Explain what your learned from this 
lab and what changes you would recommend in future years to this lab 
or the lectures leading up to this lab.</li>
</ul>

<h2>Grading - Lab 1</h2>
<table class="table table-striped table-bordered">
<thead>
<tr>
<th align="center">Item</th>
<th align="center">Grade</th>
<th align="center">Points</th>
<th align="center">Out of</th>
<th align="center">Date</th>
<th>Due</th>
</tr>
</thead>
<tbody>

<tr>
<td align="center" colspan="1">Required Functionality</td>
<td align="center" colspan="1"><strong>On-Time</strong> ------------------------------------------------------------------ <strong>Late:</strong> 1Day ---- 2Days ---- 3Days ---- 4+Days</td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1">45</td>
<td align="center" colspan="1"></td>
<td>COB L8 </td>
</tr>

<tr>
<td align="center" colspan="1">A Functionality</td>
<td align="center" colspan="1"><strong>On-Time</strong> ------------------------------------------------------------------ <strong>Late:</strong> 1Day ---- 2Days ---- 3Days ---- 4+Days</td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1">15</td>
<td align="center" colspan="1"></td>
<td>COB L8 </td>
</tr>
<tr>
<td align="center" colspan="1">Use of Git / Bitbucket</td>
<td align="center" colspan="1"><strong>On-Time:</strong> 0 ---- Check Minus ---- Check ---- Check Plus ---- <strong>Late:</strong> 1Day ---- 2Days ---- 3Days ---- 4+Days</td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1">5</td>
<td align="center" colspan="1"></td>
<td>COB L9</td>
</tr>
<tr>
<td align="center" colspan="1">Code Style</td>
<td align="center" colspan="1"><strong>On-Time:</strong> 0 ---- Check Minus ---- Check ---- Check Plus ---- <strong>Late:</strong> 1Day ---- 2Days ---- 3Days ---- 4+Days</td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1">10</td>
<td align="center" colspan="1"></td>
<td>COB L9</td>
</tr>
<tr>
<td align="center" colspan="1">README</td>
<td align="center" colspan="1"><strong>On-Time:</strong> 0 ---- Check Minus ---- Check ---- Check Plus ---- <strong>Late:</strong> 1Day ---- 2Days ---- 3Days ---- 4+Days</td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1">25</td>
<td align="center" colspan="1"></td>
<td>COB L9</td>
</tr>
<tr>
<td align="center" colspan="1"><strong>Total</strong></td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1"><strong>100</strong></td>
<td align="center" colspan="1"></td>
<td align="center" colspan="1"></td>
</tr>
</tbody>
</table>

<h2>Connecting</h2>
Your Digilent board will have a lot of connections required to make
this lab work.  The image below shows how I made these connections to
get the lab to work.
<br><img src="./img/board.jpg"><br><br>

        </div>
    </body>
</html>

